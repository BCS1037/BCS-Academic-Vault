var N=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Z=Object.prototype.hasOwnProperty;var ee=(s,r)=>{for(var t in r)N(s,t,{get:r[t],enumerable:!0})},te=(s,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of X(r))!Z.call(s,a)&&a!==t&&N(s,a,{get:()=>r[a],enumerable:!(n=Q(r,a))||n.enumerable});return s};var ne=s=>te(N({},"__esModule",{value:!0}),s);var ae={};ee(ae,{default:()=>x});module.exports=ne(ae);var W=require("obsidian");var C=require("@codemirror/view"),B=require("@codemirror/view"),j=require("@codemirror/state"),z=require("obsidian");var F=require("obsidian"),k;function D(s){let r=s.fileManager.getAllLinkResolutions().reduce((n,a)=>{let e=a.reference.link;if(e.includes("/")){let i=e.split("/");e=i[i.length-1]}return n[e]||(n[e]=[]),n[e]&&n[e].push(a),n},{});Object.entries(s.metadataCache.getLinks()).reduce((n,[a,e])=>(e.forEach(i=>{if(i.original.startsWith("[[#")||i.original.startsWith("![[#")){let c={reference:{link:i.link,displayText:i.link,position:i.position},resolvedFile:s.vault.getAbstractFileByPath(a),resolvedPaths:[i.link],sourceFile:s.vault.getAbstractFileByPath(a)};n.push(c)}}),n),[]).forEach(n=>{if(n.sourceFile){let a=`${n.sourceFile.basename}${n.reference.link}`;r[a]||(r[a]=[]),r[a]&&r[a].push(n)}}),k=r}function w(){return k}function E(s,r){let t={},n=r.metadataCache.getFileCache(s);if(!n)return t;k||D(r);let a=Object.values(r.metadataCache.metadataCache).reduce((e,i)=>{let c=i.headings;return c&&c.forEach(p=>{e.push(p.heading)}),e},[]);return n!=null&&n.blocks&&(t.blocks=Object.values(n.blocks).map(e=>({key:e.id,pos:e.position,page:s.basename,type:"block",references:k[`${s.basename}#^${e.id}`]||[]}))),n!=null&&n.headings&&(t.headings=n.headings.map(e=>({original:"#".repeat(e.level)+" "+e.heading,key:(0,F.stripHeading)(e.heading),pos:e.position,page:s.basename,type:"header",references:k[`${s.basename}#${(0,F.stripHeading)(e.heading)}`]||[]}))),n!=null&&n.sections&&(t.sections=ie(n)),n!=null&&n.links&&(t.links=n.links.map(e=>{if(e.link.includes("/")){let i=e.link.split("/");e.link=i[i.length-1]}return{key:e.link,original:e.original,type:"link",pos:e.position,page:s.basename,references:k[e.link]||[]}}),t.links&&(t.links=t.links.map(e=>{if(e.key.includes("/")){let i=e.key.split("/");e.key=i[i.length-1]}if(e.key.includes("#")&&!e.key.includes("#^")){let i=a.filter(c=>(0,F.stripHeading)(c)===e.key.split("#")[1])[0];e.original=i||void 0}return(e.key.startsWith("#^")||e.key.startsWith("#"))&&(e.key=`${e.page}${e.key}`,e.references=k[e.key]||[]),e}),t.links&&(t.linksWithoutDuplicates=t.links.filter((e,i,c)=>i===c.findIndex(p=>p.key===e.key))))),n!=null&&n.embeds&&(t.embeds=n.embeds.map(e=>{if(e.link.includes("/")){let i=e.link.split("/");e.link=i[i.length-1]}return{key:e.link,page:s.basename,type:"link",pos:e.position,references:k[e.link]||[]}}),t.embeds&&(t.embeds=t.embeds.map(e=>{if(e.key.includes("#")&&!e.key.includes("#^")&&t.headings){let i=a.filter(c=>c.includes(e.key.split("#")[1]))[0];e.original=i||void 0}return(e.key.startsWith("#^")||e.key.startsWith("#"))&&(e.key=`${s.basename}${e.key}`,e.references=k[e.key]||[]),e}),t.embeds&&(t.embedsWithDuplicates=t.embeds.filter((e,i,c)=>i===c.findIndex(p=>p.key===e.key))))),t}function ie(s){return s.listItems?s.sections.map(r=>{let t=[];return r.type==="list"?(s.listItems.forEach(a=>{var e,i,c,p;if(a.position.start.line>=r.position.start.line&&a.position.start.line<=r.position.end.line){let g=((i=(e=s.embeds)==null?void 0:e.find(f=>f.position.start.line===a.position.start.line))==null?void 0:i.link)||((p=(c=s.links)==null?void 0:c.find(f=>f.position.start.line===a.position.start.line))==null?void 0:p.link)||"";t.push({key:g,pos:a.position,...a})}}),{items:t,...r}):r}):s.sections}var $=async(s,r)=>{s.preventDefault();let t=s.target,n=t.getAttribute("data-snw-key"),a=t.getAttribute("data-snw-type"),e=t.getAttribute("data-snw-link");r.activateView(n,a,e)};function b(s,r,t,n,a,e){let i=document.createElement("span");return i.className="snw-reference snw-"+t,i.innerText=" "+r.toString()+" ",i.setAttribute("data-snw-key",n),i.setAttribute("data-snw-type",t),i.setAttribute("data-snw-link",a),i.ariaLabel=e,i.onclick=c=>$(c,s),i}function H(s,r,t){var i,c,p,g,f;let n=t.app.vault.fileMap[r.sourcePath];if((c=(i=app.metadataCache.getFileCache(n))==null?void 0:i.frontmatter)!=null&&c["kanban-plugin"])return;let a=n.path,e=E(n,t.app);if((e==null?void 0:e.blocks)||e.embedsWithDuplicates||e.headings||e.linksWithoutDuplicates){let l=r.getSectionInfo(s);if(e!=null&&e.blocks){for(let u of e.blocks)if(u.references.length>0&&u.pos.end.line===(l==null?void 0:l.lineEnd)){let d=b(t,u.references.length,"block",u.key,u.references[0].reference.link,m(a,u)),o=s.querySelector("p");if(o||(o=s.querySelector("li")),!o.hasClass("snw-block-preview")){o.append(d),o.addClass("snw-block-preview");break}}}if(((p=e==null?void 0:e.embedsWithDuplicates)==null?void 0:p.length)>0&&s.querySelectorAll(".internal-embed:not(.snw-embed-preview)").forEach(u=>{let d=u.getAttribute("src");for(let o of e.embedsWithDuplicates)if(o.references.length>1&&d.endsWith(o.key)){u.addClass("snw-embed-preview"),u.after(b(t,o.references.length,"embed",o.key,o.references[0].reference.link,m(a,o)));break}}),((g=e==null?void 0:e.headings)==null?void 0:g.length)>0&&s.querySelector("[data-heading]")){let u=s.querySelector("[data-heading]").textContent;for(let d of e.headings)if(d.references.length>0&&d.key===u){let o=b(t,d.references.length,"heading",d.key,d.references[0].reference.link,m(a,d));s.querySelector("h1").insertAdjacentElement("beforeend",o),s.querySelector("h1").addClass("snw-heading-preview");break}}((f=e==null?void 0:e.linksWithoutDuplicates)==null?void 0:f.length)>0&&s.querySelectorAll("a.internal-link:not(.snw-link-preview)").forEach(u=>{let d=u.getAttribute("data-href");for(let o of e.linksWithoutDuplicates)if(o.references.length>1&&(o.key===d||o.original.includes(d))){u.addClass("snw-link-preview"),u.after(b(t,o.references.length,"link",o.key,o.references[0].reference.link,m(a,o)));break}})}}function m(s,r){let t=r.references.filter(n=>s!=n.sourceFile.path).map(n=>n.sourceFile.path.replace(".md",""));return t.length>0?t.join(`
`)+`
-----
-> CLICK for more details`:""}var _;function U(s){_=s}var se=B.ViewPlugin.fromClass(class{constructor(s){this.mdView=s.state.field(z.editorInfoField),this.app=this.mdView.app,this.decorations=K(s,this.app,this.mdView)}update(s){(s.docChanged||s.viewportChanged)&&(this.decorations=K(s.view,this.app,this.mdView))}},{decorations:s=>s.decorations}),q=class extends C.WidgetType{constructor(t,n,a,e,i){super();this.referenceCount=t,this.referenceType=n,this.key=a,this.link=e,this.arialLabel=i}eq(t){return t.referenceCount==this.referenceCount}toDOM(){return b(_,this.referenceCount,this.referenceType,this.key,this.link,this.arialLabel)}destroy(){}ignoreEvent(){return!1}};function O(s,r){let t=[];for(let n=0;n<s.length;++n)s.substring(n,n+r.length)==r&&t.push(n);return t}function K(s,r,t){let n=new j.RangeSetBuilder;if((t==null?void 0:t.file)===void 0)return n.finish();let a=t.file.path,e=[],i=E(t.file,r),c=s.viewport,p=0,g=f=>{if(c.to>=p&&c.from<=p){if(i.blocks){for(let l of i.blocks)if(l.references.length>0&&f.endsWith(` ^${l.key}`)){e.push({type:"block",pos:l.pos.end.offset,count:l.references.length,key:l.key,link:l.references[0].reference.link,arialLabel:m(a,l)});break}}if(i.headings){for(let l of i.headings)if(l.references.length>1&&f===l.original){e.push({type:"heading",pos:p+f.length,count:l.references.length,key:l.original,link:l.references[0].reference.link,arialLabel:m(a,l)});break}}if(i.embedsWithDuplicates)for(let l of i.embedsWithDuplicates)l.references.length>1&&O(f,l.key).forEach(u=>{f==l.references[0].reference.original&&(u+=1),e.push({type:"embed",count:l.references.length,pos:p+u+l.key.length+2,key:l.key,link:l.references[0].reference.link,arialLabel:m(a,l)})});if(i.linksWithoutDuplicates)for(let l of i.linksWithoutDuplicates)l.references.length>1&&O(f,l.key).forEach(u=>e.push({type:"link",count:l.references.length,pos:p+u+l.key.length,key:l.key,link:l.references[0].reference.link,arialLabel:m(a,l)}))}};return s.state.doc.children?s.state.doc.children.forEach(f=>{f.text.forEach(l=>{g(l),p+=l.length+1})}):s.state.doc.text.forEach(f=>{g(f),p+=f.length+1}),e.sort((f,l)=>f.pos-l.pos).forEach(f=>{n.add(f.pos,f.pos,C.Decoration.widget({widget:new q(f.count,f.type,f.key,f.link,f.arialLabel),side:1}))}),n.finish()}var G=se;var A=require("obsidian");var v="Strange New Worlds",Y=(s,r)=>{let t=app.metadataCache.getCache(s);if(t!=null&&t.links){for(let n of t.links)if(n.link===r)return n.position.start.line}if(t!=null&&t.embeds){for(let n of t.embeds)if(n.link===r)return n.position.start.line}if(t!=null&&t.blocks){for(let n of Object.entries(t==null?void 0:t.blocks))if(n[1].id===r)return n[1].position.start.line}if(t!=null&&t.headings){let n=r.replace("#","");for(let a of t.headings)if(a.heading===n)return a.position.start.line}return 0},S=class extends A.ItemView{constructor(t,n){super(t);this.thePlugin=n}getViewType(){return v}getDisplayText(){return"Strange New Worlds"}getIcon(){return"dot-network"}async onOpen(){var d;let t=this.containerEl;t.empty(),t.innerHTML='<span class="snw-sidepane-loading">Discovering new worlds...</span>';let n=this.thePlugin.lastSelectedReferenceKey,a=this.thePlugin.lastSelectedReferenceType,e=this.thePlugin.lastSelectedReferenceLink,i="",c="",p=[];switch(a){case"link":p=w()[n],i="Target:",c="Backlinks to target:";break;case"embed":i="Target:",c="Backlinks to target:",p=w()[n];break;case"block":i="Target:",c="Backlinks to target:",p=w()[e],p===void 0&&(p=w()[this.thePlugin.app.workspace.activeLeaf.view.file.basename+"#^"+n]);break;case"heading":i="Target:",c="Backlinks to target:",p=w()[e];break;case"File":i="Target:",c="Incoming links to target:",Object.entries(w()).forEach((o,h)=>{o[1].forEach(y=>{y.resolvedFile.path===e&&p.push(y)})});break}if(p.length===0)return;let g='<div class="snw-sidepane-container">';g=g+'<div class="snw-sidepane-header">'+i+"</div>";let f=a==="File"?e:(d=p[0])==null?void 0:d.resolvedFile.path;g+=`<a class="internal-link snw-sidepane-link" 
                      snw-data-line-number="${a==="File"?0:Y(p[0].resolvedFile.path,p[0].reference.link.replace(p[0].resolvedFile.basename,"").replace("#^",""))}" 
                      snw-data-file-name="${f}"
                      data-href="${e}">${e.replace(".md","")}</a> `,g+=`<div class="snw-sidepane-header-references-header">${c}</div>`;let u=p.sort((o,h)=>o.sourceFile.basename.localeCompare(h.sourceFile.basename)||Number(o.reference.position.start.line)-Number(h.reference.position.start.line));window.snwAPI.console("sortedRefCache",u),g+='<ul class="snw-sidepane-references">',u.forEach(o=>{g+='<li class="snw-sidepane-reference-item">',a==="File"&&(g+='<span class="snw-sidepane-reference-label-from">From: </span>'),g+=`<a class="internal-link snw-sidepane-link snw-sidepane-reference-item-from" 
                          snw-data-line-number="${o.reference.position.start.line}" 
                          snw-data-file-name="${o.sourceFile.path}"
                          data-href="${o.sourceFile.path}" 
                          href="${o.sourceFile.path}">${o.sourceFile.basename}</a><br/>`,a==="File"&&(g+=`<span class="snw-sidepane-reference-label-to">To: </span>
                            <a class="internal-link snw-sidepane-link snw-sidepane-reference-item-to" 
                            snw-data-line-number="${Y(o.resolvedFile.path,o.reference.link.replace(o.resolvedFile.basename,"").replace("#^",""))}" 
                            snw-data-file-name="${o.resolvedFile.path}"
                            data-href="${o.reference.link}" 
                            href="${o.resolvedFile.path}">${o.reference.link}</a>`),g+="</li>"}),g+="</ul>",g+="</div>",t.innerHTML=g,setTimeout(()=>{document.querySelectorAll(".snw-sidepane-link").forEach(o=>{o.addEventListener("click",h=>{h.preventDefault();let y=h.target,L=y.getAttribute("snw-data-file-name"),R=Number(y.getAttribute("snw-data-line-number")),T=app.metadataCache.getFirstLinkpathDest(L,L);h.shiftKey?this.thePlugin.app.workspace.getLeaf("split","vertical").openFile(T):h.ctrlKey||h.metaKey?this.thePlugin.app.workspace.getLeaf("window").openFile(T):h.altKey?this.thePlugin.app.workspace.getLeaf("split","horizontal").openFile(T):this.thePlugin.app.workspace.getLeaf(!1).openFile(T),setTimeout(()=>{this.thePlugin.app.workspace.getActiveViewOfType(A.MarkdownView).setEphemeralState({line:R})},100)}),this.app.internalPlugins.plugins["page-preview"].enabled===!0&&o.addEventListener("mouseover",h=>{let y=app.internalPlugins.plugins["page-preview"].instance.overrides["obsidian42-strange-new-worlds"]!=!1;if(y===!1||y===!0&&(h.ctrlKey||h.metaKey)){let L=h.target,R={scroll:Number(L.getAttribute("snw-data-line-number"))},T=L.getAttribute("snw-data-file-name");app.workspace.trigger("link-hover",{},L,T,"",R)}})})},500)}async onClose(){}};function V(s){s.app.workspace.iterateAllLeaves(r=>{r.view.getViewType()==="markdown"&&re(s,r.view)})}function re(s,r){let n=s.app.fileManager.getAllLinkResolutions().filter(i=>(i==null?void 0:i.resolvedFile.path)===r.file.path),a=r.containerEl.querySelector(".view-content"),e=n.map(i=>i.sourceFile.path.replace(".md","")).slice(0,20).join(`
`);if(n.length===0){r.containerEl.querySelector(".snw-header-count-wrapper")&&r.containerEl.querySelector(".snw-header-count-wrapper").remove();return}if(a){let i,c=r.containerEl.querySelector(".snw-header-count-wrapper");c?i=r.containerEl.querySelector(".snw-header-count"):(c=document.createElement("div"),c.className="snw-header-count-wrapper",i=document.createElement("div"),i.className="snw-header-count",c.appendChild(i),a.prepend(c)),i.innerText=" "+n.length.toString()+" ",i.setAttribute("data-snw-key",r.file.basename),i.setAttribute("data-snw-type","File"),i.setAttribute("data-snw-link",r.file.path),i.ariaLabel=`Strange New Worlds
`+e+`
----
-->Click for more details`,i.onclick=p=>$(p,s)}}var M=require("obsidian"),J={debugMode:!1},I=class extends M.PluginSettingTab{constructor(t,n){super(t,n);this.plugin=n}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Obsidian42 - Strange New Worlds"}),new M.Setting(t).setName("Developer Debugging Mode").setDesc("Enable Debugging Mode for troubleshooting in the console.").addToggle(n=>{n.setValue(this.plugin.settings.debugMode),n.onChange(async a=>{this.plugin.settings.debugMode=a,await this.plugin.saveSettings()})})}};var P=class{constructor(r){this.console=(r,...t)=>{this.plugin.settings.debugMode===!0&&console.log("SNW: "+r,t)};this.getMetaInfoByCurrentFile=async()=>this.getMetaInfoByFileName(app.workspace.getActiveFile().path);this.getMetaInfoByFileName=async r=>{let t=app.metadataCache.getFirstLinkpathDest(r,"/");return{TFile:t,metadataCache:app.metadataCache.getFileCache(t),SnwTransformedCache:E(t,this.plugin.app)}};this.plugin=r}};var x=class extends W.Plugin{constructor(){super(...arguments);this.pluginInitialized=!1;this.appName="Obsidian42 - Strange New Worlds";this.appID="obsidian42-strange-new-worlds"}async onload(){console.log("loading "+this.appName);let t=(0,W.debounce)(()=>{D(this.app)},3e3,!0),n=async()=>{await this.loadSettings(),U(this),this.registerEditorExtension([G]),this.registerEvent(this.app.metadataCache.on("resolve",a=>t())),this.registerMarkdownPostProcessor((a,e)=>H(a,e,this)),this.registerView(v,a=>new S(a,this)),this.app.workspace.on("layout-change",async()=>{V(this)}),this.addSettingTab(new I(this.app,this)),this.app.workspace.registerHoverLinkSource(this.appID,{display:this.appName,defaultMod:!0}),globalThis.snwAPI=new P(this)};setTimeout(async()=>{this.pluginInitialized||(this.pluginInitialized=!0,await n())},4e3),this.app.workspace.onLayoutReady(()=>{let a=this.app.metadataCache.on("resolved",()=>{this.app.metadataCache.offref(a),this.pluginInitialized||(this.pluginInitialized=!0,n())})})}async activateView(t,n,a){this.lastSelectedReferenceKey=t,this.lastSelectedReferenceType=n,this.lastSelectedReferenceLink=a,this.app.workspace.detachLeavesOfType(v),await this.app.workspace.getRightLeaf(!1).setViewState({type:v,active:!0}),this.app.workspace.revealLeaf(this.app.workspace.getLeavesOfType(v)[0])}onunload(){this.app.workspace.detachLeavesOfType(v),this.app.workspace.unregisterHoverLinkSource(this.appID),console.log("unloading "+this.appName)}async loadSettings(){this.settings=Object.assign({},J,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
